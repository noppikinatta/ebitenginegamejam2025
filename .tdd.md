# Core Package TDD Implementation Plan

## 概要
Ebitengine Game Jam 2025向けストラテジーゲームのcoreパッケージ実装計画

## 実装フェーズ

### フェーズ1: 基本データ構造
**優先度: 最高** - 他のすべてのシステムが依存

#### 1.1 ResourceQuantity (resource.go)
- [ ] `resource_test.go` 作成
  - [ ] Add()メソッドのテスト（正常系・境界値）
  - [ ] Sub()メソッドのテスト（正常系・マイナス値対応）
  - [ ] CanPurchase()メソッドのテスト（各リソース不足パターン）
- [ ] ResourceQuantity構造体実装
- [ ] メソッド実装（Add, Sub, CanPurchase）

#### 1.2 Turn拡張 (turn.go)
- [ ] `turn_test.go` 作成
  - [ ] YearMonth()のテスト（既存実装済み）
  - [ ] Turn進行に関するテスト
- [ ] 必要に応じてTurn操作メソッド追加

### フェーズ2: カードシステム基盤
**優先度: 高** - 戦闘・マーケット・領土システムの基盤

#### 2.1 基本カード構造 (card.go)
- [ ] `card_test.go` 作成
  - [ ] CardPack.Open()のテスト（確率分布・モック使用）
  - [ ] CardDatabase.GetCards()のテスト
  - [ ] BattleCardPowerModifier.Modify()のテスト
- [ ] CardPack構造体・Open()メソッド実装
- [ ] Cardsコンテナ実装
- [ ] CardDatabase実装
- [ ] CardDeck実装

#### 2.2 カードスキルシステム
- [ ] BattleCardSkill実装
- [ ] EnemySkillBlocker実装
- [ ] BattleCardPowerModifier実装
- [ ] YieldModifier実装
- [ ] BattlefieldModifier実装

### フェーズ3: 敵・戦闘システム
**優先度: 高** - ゲームの核心メカニクス

#### 3.1 Enemy (enemy.go)
- [ ] `enemy_test.go` 作成
  - [ ] Enemy構造体のテスト
  - [ ] EnemySkill.CanAffect()のテスト
  - [ ] EnemySkill.Modify()のテスト
- [ ] Enemy構造体実装
- [ ] EnemySkill実装

#### 3.2 Battle (battle.go)
- [ ] `battle_test.go` 作成
  - [ ] Battlefield.CanBeat()のテスト（複数シナリオ）
  - [ ] Battlefield.Beat()のテスト
  - [ ] SupportPowerの計算テスト
  - [ ] BattleCardStateの状態管理テスト
- [ ] Battlefield構造体実装
- [ ] 戦闘力計算ロジック実装
- [ ] スキル効果適用ロジック実装

### フェーズ4: 領土・マーケットシステム
**優先度: 中** - 経済システム

#### 4.1 Territory (territory.go)
- [ ] `territory_test.go` 作成
  - [ ] Territory.AppendCard()のテスト
  - [ ] Territory.RemoveCard()のテスト
  - [ ] Territory.Yield()のテスト（YieldModifier適用）
- [ ] Territory構造体実装
- [ ] カード配置・除去メソッド実装
- [ ] Yield計算実装

#### 4.2 Market (market.go)
- [ ] `market_test.go` 作成
  - [ ] Market.VisibleCardPacks()のテスト
  - [ ] Market.CanPurchase()のテスト
  - [ ] Market.Purchase()のテスト
  - [ ] MarketItem.CanPurchase()のテスト
- [ ] Market構造体実装
- [ ] MarketItem実装
- [ ] 購入ロジック実装

### フェーズ5: 国家システム
**優先度: 中** - プレイヤー・NPC管理

#### 5.1 Nation基盤 (nation.go)
- [ ] `nation_test.go` 作成
  - [ ] Nation.VisibleCardPacks()のテスト
  - [ ] Nation.CanPurchase()のテスト
  - [ ] Nation.Purchase()のテスト
  - [ ] Treasury.Add()のテスト
  - [ ] Treasury.Sub()のテスト
- [ ] Nation構造体実装
- [ ] Treasury実装

#### 5.2 MyNation・OtherNation
- [ ] MyNation実装（BasicYield、AppendMarketItem、AppendLevel）
- [ ] OtherNation実装（Market.Level加算ロジック）

### フェーズ6: マップグリッドシステム
**優先度: 中** - 空間管理・インタラクション

#### 6.1 MapGrid (mapgrid.go)
- [ ] `mapgrid_test.go` 作成
  - [ ] MapGrid.CanInteract()のテスト（隣接判定）
  - [ ] 制圧済みWilderness経由のアクセステスト
  - [ ] 遠回りルートのテスト
- [ ] MapGrid構造体実装
- [ ] Point実装（MyNationPoint, OtherNationPoint, WildernessPoint, BossPoint）
- [ ] 隣接判定・アクセス可能性判定実装

### フェーズ7: 統合・ゲームフロー
**優先度: 低** - 全体の結合

#### 7.1 ターン進行システム
- [ ] ターン経過時のYield加算テスト
- [ ] ゲーム状態更新テスト
- [ ] 勝利条件判定テスト

#### 7.2 統合テスト
- [ ] 実際のゲームフロー通しテスト
- [ ] パフォーマンステスト
- [ ] エラーハンドリングテスト

## テスト戦略
- **テストデータ**: core/testdata/ に配置
- **モック**: 乱数生成、外部依存をインタフェースで抽象化
- **テーブル駆動テスト**: 複数シナリオのテストに活用
- **ベンチマーク**: 戦闘計算など重要な処理

## 実装時の注意点
- **Game Jam制約**: 完璧性より動作優先、ハードコーディング許容
- **依存関係**: 下位フェーズ完了後に上位フェーズ着手
- **型安全性**: Go の型システムを活用してバグを防止
- **テスト優先**: 実装前にテストを書き、仕様を明確化

## 完了判定基準
各フェーズは以下の条件で完了とする：
1. すべてのテストが通る
2. `go test -race ./core/...` が通る
3. 基本的なコードカバレッジを満たす
4. 他のパッケージとの統合テストが通る
