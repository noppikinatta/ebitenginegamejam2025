# UI実装詳細計画

このドキュメントは`design_switching.md`の設計をもとにした詳細な実装計画です。

## 1. MarketView機能の改修

### 1.1 MarketViewの構造体改修
- [x] `MarketView`に`Nation *core.Nation`フィールドを追加
- [x] `MarketView`に`GameState *core.GameState`フィールドを追加
- [x] `SetNation(nation *core.Nation)`メソッドを追加

### 1.2 Nation.Marketの全MarketItem表示
- [x] 現在の`VisibleMarketItem`ロジックを削除
- [x] `Nation.Market`の全`[]*MarketItem`を表示するように変更
- [x] レベル不足のMarketItemは非表示ではなく、レベル不足表示を追加

### 1.3 購入処理の実装
- [x] `PurchaseCardPack(item *core.MarketItem) error`メソッドを追加
- [x] 処理フロー：
  1. `GameState.Treasury`の残高チェック
  2. `Market.Purchase`でCardPackを取得
  3. `CardPack.Open`でCardsを取得
  4. `GameState.CardDeck.Add(Cards)`でデッキに追加
  5. 購入完了後、MapGridViewに戻る

### 1.4 CardDeck.Addメソッドの実装
- [x] `core/card.go`に`CardDeck.Add(cards *Cards)`メソッドを追加

## 2. BattleView機能の改修

### 2.1 BattleViewの構造体改修
- [x] `BattleView`に`Battlefield *core.Battlefield`フィールドを追加
- [x] `BattleView`に`TargetX, TargetY int`フィールドを追加（制圧時座標用）

### 2.2 SetEnemyメソッドの実装
- [x] `SetEnemy(enemy *core.Enemy, x, y int)`メソッドを追加
- [x] 処理フロー：
  1. 引数でenemy, x, yを受け取り
  2. Battlefieldを作成してセット
  3. TargetX, TargetYをセット

### 2.3 Battlefield作成ロジックの実装
- [x] `createBattlefield(enemy *core.Enemy, x, y int) *core.Battlefield`メソッドを追加
- [x] 処理フロー：
  1. Enemyをセット
  2. x,yをもとに上下左右のPointを調査
  3. ControlledなWildernessPointからTerritoryを取得
  4. Territory.CardsのStructureCard.BattlefieldModifierを適用（nilチェック付き）

### 2.4 制圧処理の実装
- [x] 制圧ボタンの表示判定：BattleCardのPower合計 vs EnemyのPower
- [x] `Conquer()`メソッドを追加
- [x] 処理フロー：
  1. 対象WildernessPointのControlledをtrueに変更
  2. MapGridViewに戻る

## 3. TerritoryView機能の改修

### 3.1 TerritoryViewの構造体改修
- [x] `TerritoryView`に`Cards []*core.StructureCard`フィールドを追加（一時的カード置き場）
- [x] Territory.Cardsとメモリ共有しないよう注意

### 3.2 変更状態表示の実装
- [x] 座標(440,20,40,40)に変更状態表示エリアを追加
- [x] `IsChanged() bool`メソッドを追加
- [x] 判定ロジック：
  1. len(TerritoryView.Cards) != len(Territory.Cards)なら変更有り
  2. 両スライスのStructureCardポインタが全て同じなら変更無し（順番は問わない）
- [x] 変更有りの場合「*」マークを表示

### 3.3 建設決定処理の実装
- [x] `ConfirmConstruction()`メソッドを追加
- [x] 処理フロー：
  1. TerritoryView.Cardsの内容をTerritory.Cardsにコピー
  2. MapGridViewに戻る

## 4. CardDeckView機能の改修

### 4.1 CardDeckViewの構造体改修
- [x] `OnBattleCardClicked func(*core.BattleCard) bool`フィールドを追加
- [x] `OnStructureCardClicked func(*core.StructureCard) bool`フィールドを追加

### 4.2 カードクリック処理の実装
- [x] BattleCardクリック時に`OnBattleCardClicked`を呼び出し
- [x] StructureCardクリック時に`OnStructureCardClicked`を呼び出し
- [x] 戻り値がtrueの場合、CardDeckからカードを削除

## 5. MainView統合機能の実装

### 5.1 OnBattleCardClicked関数の実装
- [x] MainViewに以下の関数を定義し、CardDeckViewに登録：
```go
func (mv *MainView) onBattleCardClicked(card *core.BattleCard) bool {
    if mv.CurrentView != ViewTypeBattle {
        return false
    }
    
    if mv.BattleView.CanPlaceCard() {
        mv.BattleView.PlaceCard(card)
        return true
    }
    
    return false
}
```

### 5.2 OnStructureCardClicked関数の実装
- [x] MainViewに以下の関数を定義し、CardDeckViewに登録：
```go
func (mv *MainView) onStructureCardClicked(card *core.StructureCard) bool {
    if mv.CurrentView != ViewTypeTerritory {
        return false
    }
    
    if mv.TerritoryView.CanPlaceCard() {
        mv.TerritoryView.PlaceCard(card)
        return true
    }
    
    return false
}
```

## 6. カード返却機能の実装

### 6.1 BattleViewからCardDeckへの返却
- [x] BattleView内のカードがクリックされた際の処理を追加
- [x] `RemoveCard(card *core.BattleCard)`メソッドを追加
- [x] GameState.CardDeckに追加

### 6.2 TerritoryViewからCardDeckへの返却
- [x] TerritoryView内のカードがクリックされた際の処理を追加
- [x] `RemoveCard(card *core.StructureCard)`メソッドを追加
- [x] GameState.CardDeckに追加

## 7. 実装順序

- [x] 1. `core/card.go`: CardDeck.Addメソッドの追加
- [x] 2. `ui/market.go`: MarketViewの改修
- [x] 3. `ui/battle.go`: BattleViewの改修
- [x] 4. `ui/territory.go`: TerritoryViewの改修
- [x] 5. `ui/carddeck.go`: CardDeckViewの改修
- [x] 6. `ui/mainview.go`: MainViewの統合機能実装
- [ ] 7. 各画面遷移処理の実装とテスト

## 8. 注意事項

- [x] ゲームジャム期間中のため、適度なハードコーディングは許容する
- [x] メモリ共有の問題に注意（特にTerritoryView.Cards）
- [x] nilチェックを忘れずに実装（BattlefieldModifier等）
- [x] 既存機能との競合に注意（既存のCardDeckView実装など）

## 9. 残課題

### 9.1 MapGridViewの座標連携
- [ ] MapGridViewのOnPointClickedコールバックで座標も渡すように変更
- [ ] MainView.SetSelectedPointで実際の座標を使用

### 9.2 CardDatabaseの実装
- [ ] MarketViewのPurchaseCardPack内でダミー実装されている部分を改善
- [ ] 実際のCardDatabaseからCardsを取得する機能を実装
